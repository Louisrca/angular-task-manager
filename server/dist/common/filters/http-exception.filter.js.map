{"version":3,"sources":["../../../src/common/filters/http-exception.filter.ts"],"sourcesContent":["import {\n  ExceptionFilter,\n  Catch,\n  ArgumentsHost,\n  HttpException,\n  HttpStatus,\n  Logger,\n} from '@nestjs/common';\nimport { Request, Response } from 'express';\nimport { QueryFailedError } from 'typeorm';\n\n@Catch()\nexport class AllExceptionsFilter implements ExceptionFilter {\n  private readonly logger = new Logger(AllExceptionsFilter.name);\n\n  catch(exception: unknown, host: ArgumentsHost) {\n    const ctx = host.switchToHttp();\n    const response = ctx.getResponse<Response>();\n    const request = ctx.getRequest<Request>();\n\n    let status = HttpStatus.INTERNAL_SERVER_ERROR;\n    let message = 'Internal server error';\n    let error = 'Internal Server Error';\n\n    if (exception instanceof HttpException) {\n      status = exception.getStatus();\n      const responseBody: any = exception.getResponse();\n      message = responseBody.message || exception.message;\n      error = responseBody.error || 'Http Exception';\n    } else if (exception instanceof QueryFailedError) {\n      // Gestion sp√©cifique des erreurs TypeORM / Postgres\n      const err: any = exception;\n      // Code 23505 = Unique Violation (Doublon)\n      if (err.code === '23505') {\n        status = HttpStatus.CONFLICT;\n        message = 'Username already exists';\n        error = 'Conflict';\n      } else {\n        // Autres erreurs SQL\n        this.logger.error(`Database Error: ${err.message}`, err.stack);\n      }\n    } else {\n      // Autres erreurs inconnues\n      if (exception instanceof Error) {\n        this.logger.error(`Unexpected Error: ${exception.message}`, exception.stack);\n      } else {\n        this.logger.error(`Unexpected Error: ${exception}`);\n      }\n    }\n\n    response.status(status).json({\n      statusCode: status,\n      timestamp: new Date().toISOString(),\n      path: request.url,\n      error: error,\n      message: message,\n    });\n  }\n}\n"],"names":["AllExceptionsFilter","catch","exception","host","ctx","switchToHttp","response","getResponse","request","getRequest","status","HttpStatus","INTERNAL_SERVER_ERROR","message","error","HttpException","getStatus","responseBody","QueryFailedError","err","code","CONFLICT","logger","stack","Error","json","statusCode","timestamp","Date","toISOString","path","url","Logger","name"],"mappings":";;;;+BAYaA;;;eAAAA;;;wBALN;yBAE0B;;;;;;;AAG1B,IAAA,AAAMA,sBAAN,MAAMA;IAGXC,MAAMC,SAAkB,EAAEC,IAAmB,EAAE;QAC7C,MAAMC,MAAMD,KAAKE,YAAY;QAC7B,MAAMC,WAAWF,IAAIG,WAAW;QAChC,MAAMC,UAAUJ,IAAIK,UAAU;QAE9B,IAAIC,SAASC,kBAAU,CAACC,qBAAqB;QAC7C,IAAIC,UAAU;QACd,IAAIC,QAAQ;QAEZ,IAAIZ,qBAAqBa,qBAAa,EAAE;YACtCL,SAASR,UAAUc,SAAS;YAC5B,MAAMC,eAAoBf,UAAUK,WAAW;YAC/CM,UAAUI,aAAaJ,OAAO,IAAIX,UAAUW,OAAO;YACnDC,QAAQG,aAAaH,KAAK,IAAI;QAChC,OAAO,IAAIZ,qBAAqBgB,yBAAgB,EAAE;YAChD,oDAAoD;YACpD,MAAMC,MAAWjB;YACjB,0CAA0C;YAC1C,IAAIiB,IAAIC,IAAI,KAAK,SAAS;gBACxBV,SAASC,kBAAU,CAACU,QAAQ;gBAC5BR,UAAU;gBACVC,QAAQ;YACV,OAAO;gBACL,qBAAqB;gBACrB,IAAI,CAACQ,MAAM,CAACR,KAAK,CAAC,CAAC,gBAAgB,EAAEK,IAAIN,OAAO,EAAE,EAAEM,IAAII,KAAK;YAC/D;QACF,OAAO;YACL,2BAA2B;YAC3B,IAAIrB,qBAAqBsB,OAAO;gBAC9B,IAAI,CAACF,MAAM,CAACR,KAAK,CAAC,CAAC,kBAAkB,EAAEZ,UAAUW,OAAO,EAAE,EAAEX,UAAUqB,KAAK;YAC7E,OAAO;gBACL,IAAI,CAACD,MAAM,CAACR,KAAK,CAAC,CAAC,kBAAkB,EAAEZ,WAAW;YACpD;QACF;QAEAI,SAASI,MAAM,CAACA,QAAQe,IAAI,CAAC;YAC3BC,YAAYhB;YACZiB,WAAW,IAAIC,OAAOC,WAAW;YACjCC,MAAMtB,QAAQuB,GAAG;YACjBjB,OAAOA;YACPD,SAASA;QACX;IACF;;aA5CiBS,SAAS,IAAIU,cAAM,CAAChC,oBAAoBiC,IAAI;;AA6C/D"}