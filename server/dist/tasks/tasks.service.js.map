{"version":3,"sources":["../../src/tasks/tasks.service.ts"],"sourcesContent":["import { Injectable, NotFoundException, ForbiddenException } from '@nestjs/common';\nimport { InjectRepository } from '@nestjs/typeorm';\nimport { Repository } from 'typeorm';\nimport { CreateTaskDto } from './dto/create-task.dto';\nimport { UpdateTaskDto } from './dto/update-task.dto';\nimport { Task } from './entities/task.entity';\nimport { UserRole } from '../users/entities/role.enum';\nimport { User } from '../users/entities/user.entity';\n\n@Injectable()\nexport class TasksService {\n  constructor(\n    @InjectRepository(Task)\n    private tasksRepository: Repository<Task>,\n  ) {}\n\n\n  async create(createTaskDto: CreateTaskDto, user: any) {\n    let targetId = user.userId;\n\n    // Si l'utilisateur est ADMIN et qu'il spécifie un ID cible, on utilise cet ID\n    if (user.role === UserRole.ADMIN && createTaskDto.targetUserId) {\n      targetId = createTaskDto.targetUserId;\n    }\n\n    // On crée la tâche en l'associant à l'ID déterminé\n    const { targetUserId, ...taskData } = createTaskDto; // On retire targetUserId des données de la tâche\n    const task = this.tasksRepository.create({\n      ...taskData,\n      user: { id: targetId } as User,\n    });\n    \n    const savedTask = await this.tasksRepository.save(task);\n    const { user: owner, ...result } = savedTask;\n    return result;\n  }\n\n  async findAll(user: any) {\n    if (user.role === UserRole.ADMIN) {\n      return this.tasksRepository.find({ order: { id: 'DESC' }, relations: ['user'] });\n    }\n    // Si User, seulement les siennes\n    return this.tasksRepository.find({\n      where: { user: { id: user.userId } },\n      order: { id: 'DESC' },\n      relations: ['user'],\n    });\n  }\n\n  async findOne(id: number, user: any) {\n    const task = await this.tasksRepository.findOne({ where: { id }, relations: ['user'] });\n    if (!task) throw new NotFoundException(`Task #${id} not found`);\n\n    if (user.role !== UserRole.ADMIN && task.user?.id !== user.userId) {\n      throw new ForbiddenException('You do not have permission to access this task');\n    }\n    return task;\n  }\n\n  async update(id: number, updateTaskDto: UpdateTaskDto, user: any) {\n    const task = await this.findOne(id, user); // Vérifie l'existence et les droits\n\n    const { targetUserId, ...updateData } = updateTaskDto;\n\n    // Gestion de la réassignation (Admin seulement)\n    if (targetUserId && user.role === UserRole.ADMIN) {\n      task.user = { id: targetUserId } as User;\n    }\n\n    this.tasksRepository.merge(task, updateData);\n    return this.tasksRepository.save(task);\n  }\n\n  async remove(id: number, user: any) {\n    const task = await this.findOne(id, user); // Vérifie l'existence et les droits\n    return this.tasksRepository.remove(task);\n  }\n}\n"],"names":["TasksService","create","createTaskDto","user","targetId","userId","role","UserRole","ADMIN","targetUserId","taskData","task","tasksRepository","id","savedTask","save","owner","result","findAll","find","order","relations","where","findOne","NotFoundException","ForbiddenException","update","updateTaskDto","updateData","merge","remove"],"mappings":";;;;+BAUaA;;;eAAAA;;;wBAVqD;yBACjC;0BACN;4BAGN;0BACI;;;;;;;;;;;;;;;AAIlB,IAAA,AAAMA,eAAN,MAAMA;IAOX,MAAMC,OAAOC,aAA4B,EAAEC,IAAS,EAAE;QACpD,IAAIC,WAAWD,KAAKE,MAAM;QAE1B,8EAA8E;QAC9E,IAAIF,KAAKG,IAAI,KAAKC,kBAAQ,CAACC,KAAK,IAAIN,cAAcO,YAAY,EAAE;YAC9DL,WAAWF,cAAcO,YAAY;QACvC;QAEA,mDAAmD;QACnD,MAAM,EAAEA,YAAY,EAAE,GAAGC,UAAU,GAAGR,eAAe,iDAAiD;QACtG,MAAMS,OAAO,IAAI,CAACC,eAAe,CAACX,MAAM,CAAC;YACvC,GAAGS,QAAQ;YACXP,MAAM;gBAAEU,IAAIT;YAAS;QACvB;QAEA,MAAMU,YAAY,MAAM,IAAI,CAACF,eAAe,CAACG,IAAI,CAACJ;QAClD,MAAM,EAAER,MAAMa,KAAK,EAAE,GAAGC,QAAQ,GAAGH;QACnC,OAAOG;IACT;IAEA,MAAMC,QAAQf,IAAS,EAAE;QACvB,IAAIA,KAAKG,IAAI,KAAKC,kBAAQ,CAACC,KAAK,EAAE;YAChC,OAAO,IAAI,CAACI,eAAe,CAACO,IAAI,CAAC;gBAAEC,OAAO;oBAAEP,IAAI;gBAAO;gBAAGQ,WAAW;oBAAC;iBAAO;YAAC;QAChF;QACA,iCAAiC;QACjC,OAAO,IAAI,CAACT,eAAe,CAACO,IAAI,CAAC;YAC/BG,OAAO;gBAAEnB,MAAM;oBAAEU,IAAIV,KAAKE,MAAM;gBAAC;YAAE;YACnCe,OAAO;gBAAEP,IAAI;YAAO;YACpBQ,WAAW;gBAAC;aAAO;QACrB;IACF;IAEA,MAAME,QAAQV,EAAU,EAAEV,IAAS,EAAE;QACnC,MAAMQ,OAAO,MAAM,IAAI,CAACC,eAAe,CAACW,OAAO,CAAC;YAAED,OAAO;gBAAET;YAAG;YAAGQ,WAAW;gBAAC;aAAO;QAAC;QACrF,IAAI,CAACV,MAAM,MAAM,IAAIa,yBAAiB,CAAC,CAAC,MAAM,EAAEX,GAAG,UAAU,CAAC;QAE9D,IAAIV,KAAKG,IAAI,KAAKC,kBAAQ,CAACC,KAAK,IAAIG,KAAKR,IAAI,EAAEU,OAAOV,KAAKE,MAAM,EAAE;YACjE,MAAM,IAAIoB,0BAAkB,CAAC;QAC/B;QACA,OAAOd;IACT;IAEA,MAAMe,OAAOb,EAAU,EAAEc,aAA4B,EAAExB,IAAS,EAAE;QAChE,MAAMQ,OAAO,MAAM,IAAI,CAACY,OAAO,CAACV,IAAIV,OAAO,oCAAoC;QAE/E,MAAM,EAAEM,YAAY,EAAE,GAAGmB,YAAY,GAAGD;QAExC,gDAAgD;QAChD,IAAIlB,gBAAgBN,KAAKG,IAAI,KAAKC,kBAAQ,CAACC,KAAK,EAAE;YAChDG,KAAKR,IAAI,GAAG;gBAAEU,IAAIJ;YAAa;QACjC;QAEA,IAAI,CAACG,eAAe,CAACiB,KAAK,CAAClB,MAAMiB;QACjC,OAAO,IAAI,CAAChB,eAAe,CAACG,IAAI,CAACJ;IACnC;IAEA,MAAMmB,OAAOjB,EAAU,EAAEV,IAAS,EAAE;QAClC,MAAMQ,OAAO,MAAM,IAAI,CAACY,OAAO,CAACV,IAAIV,OAAO,oCAAoC;QAC/E,OAAO,IAAI,CAACS,eAAe,CAACkB,MAAM,CAACnB;IACrC;IAjEA,YACE,AACQC,eAAiC,CACzC;aADQA,kBAAAA;IACP;AA+DL"}